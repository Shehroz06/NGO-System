<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Smart NGO System</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f7f6;
      color: #333;
    }

    header {
      background-color: #1a5632;
      color: white;
      padding: 15px 50px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .logo {
      font-size: 1.5em;
      font-weight: bold;
    }

    nav a {
      color: white;
      text-decoration: none;
      margin-left: 20px;
      padding: 8px 15px;
      border-radius: 5px;
      transition: background-color 0.3s;
      font-size: 14px;
    }

    nav a:hover,
    nav a.active {
      background-color: #2b7049;
    }

    .donate-main-btn {
      background-color: #ff6347;
      color: white !important;
      font-weight: bold;
    }

    .dashboard-layout {
      display: flex;
      min-height: calc(100vh - 80px);
    }

    .sidebar {
      width: 280px;
      background-color: #fff;
      padding: 30px 20px;
      border-right: 1px solid #eee;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
    }

    .sidebar h2 {
      color: #1a5632;
      font-size: 1.1em;
      text-transform: uppercase;
      border-bottom: 2px solid #f4f7f6;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }

    .sidebar-menu {
      list-style: none;
      padding: 0;
    }

    .sidebar-menu li a {
      display: block;
      text-decoration: none;
      color: #555;
      padding: 12px 20px;
      margin-bottom: 8px;
      border-radius: 8px;
      transition: all 0.3s;
      font-weight: 500;
      cursor: pointer;
    }

    .sidebar-menu li a:hover {
      background-color: #e0f2e0;
      color: #1a5632;
    }

    .sidebar-menu li a.active-menu {
      background-color: #1a5632;
      color: white;
    }

    .dashboard-content {
      flex-grow: 1;
      padding: 40px 60px;
    }

    .dashboard-section {
      background-color: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
    }

    .dashboard-section h3 {
      color: #1a5632;
      margin-top: 0;
      margin-bottom: 25px;
      border-left: 5px solid #1a5632;
      padding-left: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      background-color: #f8f9fa;
      text-align: left;
      padding: 15px;
      border-bottom: 2px solid #eee;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-sizing: border-box;
    }

    .hint {
      margin-top: 6px;
      color: #666;
      font-size: 13px;
    }

    .submit-btn {
      background-color: #1a5632;
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>

  <header>
    <div class="logo">NGO Management System</div>
    <nav id="top-nav">
      <a href="/dashboard.html" class="active">Dashboard</a>
      <a href="#" id="logout-link">Logout</a>
      <a href="/donate.html" class="donate-main-btn">Donate Now</a>
    </nav>
  </header>

  <div class="dashboard-layout">
    <aside class="sidebar">
      <h2 id="acc-type-label">User Account</h2>
      <ul class="sidebar-menu">
        <li><a class="active-menu" data-target="history">Donation History</a></li>
        <li><a data-target="volunteer">Volunteer Sign-up</a></li>
        <li><a data-target="feedback">Feedback & Complaints</a></li>
        <li><a data-target="update-profile">Update Profile</a></li>
      </ul>
    </aside>

    <main class="dashboard-content">
      <h1 id="welcome-msg">Welcome!</h1>

      <section id="history" class="dashboard-section">
        <h3>Recent Contributions</h3>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Cause Title</th>
              <th>Amount</th>
              <th>Method</th>
            </tr>
          </thead>
          <tbody id="donation-history-body">
            <tr>
              <td colspan="5">Loading your history...</td>
            </tr>
          </tbody>
        </table>
      </section>

      <section id="update-profile" class="dashboard-section hidden">
        <h3>Update Your Profile</h3>
        <form id="profile-form">
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="prof-name" required>
          </div>
          <div class="form-group">
            <label>New Password</label>
            <input type="password" id="prof-pass" placeholder="Enter new password (optional)">
          </div>
          <button type="submit" class="submit-btn">Save Changes</button>
          <p id="profile-status" style="margin-top:15px;"></p>
        </form>
      </section>

      <section id="volunteer" class="dashboard-section hidden">
        <h3>Become a Volunteer</h3>
        <form id="volunteer-form">
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="vol-name" required>
          </div>
          <div class="form-group">
            <label>Skills (e.g., Marketing, IT)</label>
            <input type="text" id="vol-skill" required>
          </div>

          <div class="form-group">
            <label>Select NGO(s)</label>
            <select id="vol-ngos" multiple required size="6">
              <!-- filled by /api/ngos -->
            </select>
            <div class="hint">Tip: Hold Ctrl (Windows) / Cmd (Mac) to select multiple NGOs.</div>
          </div>

          <div class="form-group">
            <label>Availability</label>
            <select id="vol-avail" required>
              <option value="Weekend">Weekends Only</option>
              <option value="Weekday">Weekdays</option>
            </select>
          </div>
          <button type="submit" class="submit-btn">Submit Application</button>
          <p id="vol-status"></p>
        </form>
      </section>

      <section id="feedback" class="dashboard-section hidden">
        <h3>Submit Feedback</h3>

        <form id="feedback-form">
          <div class="form-group">
            <label>NGO</label>
            <select id="feed-ngo" required>
              <option value="">Select NGO</option>
            </select>
          </div>

          <div class="form-group">
            <label>Rating</label>
            <select id="feed-rating" required>
              <option value="">Select Rating</option>
              <option value="5">★★★★★ Excellent</option>
              <option value="4">★★★★ Good</option>
              <option value="3">★★★ Average</option>
              <option value="2">★★ Poor</option>
              <option value="1">★ Very Bad</option>
            </select>
          </div>

          <div class="form-group">
            <label>Message</label>
            <textarea id="feed-msg" rows="4" required></textarea>
          </div>

          <button type="submit" class="submit-btn">Send Feedback</button>
          <p id="feed-status"></p>
        </form>
      </section>

    </main>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem("authToken");
      const role = (localStorage.getItem("userRole") || "").toLowerCase();
      const userName = localStorage.getItem("userName") || "User";

      if (!token) { window.location.href = "/login.html"; return; }
      if (role === "admin") { window.location.href = "/admin/admin.html"; return; }
      if (role === "staff") { window.location.href = "/staff/staff-dashboard.html"; return; }

      // UI
      document.getElementById('welcome-msg').textContent = `Welcome back, ${userName}!`;

      // Logout
      const logoutLink = document.getElementById("logout-link");
      if (logoutLink) {
        logoutLink.addEventListener("click", (e) => {
          e.preventDefault();
          localStorage.clear();
          window.location.href = "/home.html";
        });
      }

      const authHeaders = {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      };

      // Tab Switching
      const menuLinks = document.querySelectorAll(".sidebar-menu li a[data-target]");
      const sections = document.querySelectorAll(".dashboard-section");

      menuLinks.forEach(link => {
        link.addEventListener("click", () => {
          const target = link.getAttribute("data-target");
          sections.forEach(s => s.classList.add("hidden"));
          document.getElementById(target).classList.remove("hidden");
          menuLinks.forEach(l => l.classList.remove("active-menu"));
          link.classList.add("active-menu");
        });
      });

      // -----------------------
      // Load NGOs into dropdowns
      // -----------------------
      async function loadNgos() {
        try {
          const res = await fetch("/api/ngos");
          const ngos = await res.json().catch(() => []);

          const vSel = document.getElementById("vol-ngos");
          const fSel = document.getElementById("feed-ngo");

          if (!Array.isArray(ngos) || !vSel || !fSel) return;

          // Volunteer multi-select
          vSel.innerHTML = "";
          // Feedback single select
          fSel.innerHTML = `<option value="">Select NGO</option>`;

          ngos.forEach(ngo => {
            const id = ngo.id ?? ngo.ngo_id;
            const name = ngo.name ?? "NGO";

            const opt1 = document.createElement("option");
            opt1.value = String(id);
            opt1.textContent = name;
            vSel.appendChild(opt1);

            const opt2 = document.createElement("option");
            opt2.value = String(id);
            opt2.textContent = name;
            fSel.appendChild(opt2);
          });
        } catch (e) {
          console.error("Failed to load NGOs", e);
        }
      }

      // -----------------------
      // Donation History
      // -----------------------
      fetch("/api/donations/history", { headers: authHeaders })
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById("donation-history-body");
          if (!tbody) return;

          if (!Array.isArray(data) || !data.length) {
            tbody.innerHTML = "<tr><td colspan='5'>No donations found.</td></tr>";
            return;
          }

          tbody.innerHTML = "";

          data.forEach(item => {
            const dt = item.date || item.donation_date || item.created_at || Date.now();

            const method =
              item.payment_method === "online" ? "Online Payment" :
                item.payment_method === "physical" ? "Physical Payment" :
                  "—";

            tbody.innerHTML += `
        <tr>
          <td>${new Date(dt).toLocaleDateString()}</td>
          <td><strong>${item.cause_title || item.causeTitle || item.title || "—"}</strong></td>
          <td>PKR ${(Number(item.amount || 0)).toLocaleString()}</td>
          <td>${method}</td>
        </tr>
      `;
          });
        })
        .catch(() => {
          const tbody = document.getElementById("donation-history-body");
          if (tbody) {
            tbody.innerHTML =
              "<tr><td colspan='5'>Unable to load history (backend issue).</td></tr>";
          }
        });

      // -----------------------
      // Profile Update (frontend-only)
      // -----------------------
      const profName = document.getElementById('prof-name');
      if (profName) profName.value = userName;

      const profileForm = document.getElementById('profile-form');
      if (profileForm) {
        profileForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const newName = (document.getElementById('prof-name')?.value || "").trim();
          if (newName) localStorage.setItem("userName", newName);

          const status = document.getElementById('profile-status');
          if (status) {
            status.textContent = "Profile updated successfully!";
            status.style.color = "green";
          }
          setTimeout(() => location.reload(), 800);
        });
      }

      // Auto-fill Volunteer Full Name
      const volNameInput = document.getElementById('vol-name');
      if (volNameInput) {
        volNameInput.value = userName;
      }

      // -----------------------
      // Volunteer Submit (multi NGO)
      // Sends ngo_ids[] + keeps ngo_id(first) for compatibility
      // -----------------------
      const volunteerForm = document.getElementById('volunteer-form');
      if (volunteerForm) {
        volunteerForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const statusEl = document.getElementById('vol-status');
          if (statusEl) statusEl.textContent = "Sending...";

          const sel = document.getElementById('vol-ngos');
          const ngo_ids = Array.from(sel.selectedOptions).map(o => Number(o.value)).filter(Boolean);
          const firstNgo = ngo_ids.length ? ngo_ids[0] : 0;

          const body = {
            skills: (document.getElementById('vol-skill')?.value || "").trim(),
            ngo_id: firstNgo,            // backward compatible
            ngo_ids: ngo_ids,            // NEW (multi-NGO)
            availability: (document.getElementById('vol-avail')?.value || "").trim()
          };

          if (!body.skills || !ngo_ids.length) {
            if (statusEl) {
              statusEl.textContent = "Please enter skills and select at least 1 NGO.";
              statusEl.style.color = "red";
            }
            return;
          }

          try {
            const res = await fetch('/api/user/register_volunteer', {
              method: 'POST',
              headers: authHeaders,
              body: JSON.stringify(body)
            });
            const data = await res.json().catch(() => ({}));

            if (statusEl) {
              statusEl.textContent = res.ok ? "Application sent!" : (data.message || "Failed to send.");
              statusEl.style.color = res.ok ? "green" : "red";
            }

            if (res.ok) {
              volunteerForm.reset();
              setTimeout(() => location.reload(), 700);
            }
          } catch (err) {
            if (statusEl) {
              statusEl.textContent = "Network error.";
              statusEl.style.color = "red";
            }
          }
        });
      }

      // -----------------------
      // Feedback Submit (RATING REQUIRED)
      // -----------------------
      const feedbackForm = document.getElementById('feedback-form');
      if (feedbackForm) {
        feedbackForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const statusEl = document.getElementById('feed-status');

          const ngoId = document.getElementById('feed-ngo')?.value;
          const rating = document.getElementById('feed-rating')?.value;
          const message = document.getElementById('feed-msg')?.value.trim();

          if (!ngoId || !rating || !message) {
            statusEl.textContent = "Please fill all fields including rating.";
            statusEl.style.color = "red";
            return;
          }

          statusEl.textContent = "Sending...";
          statusEl.style.color = "#333";

          try {
            const res = await fetch('/api/user/submit_feedback', {
              method: 'POST',
              headers: authHeaders,
              body: JSON.stringify({
                ngo_id: Number(ngoId),
                rating: Number(rating),
                message
              })
            });

            const data = await res.json().catch(() => ({}));

            if (res.ok) {
              statusEl.textContent = "Feedback submitted successfully!";
              statusEl.style.color = "green";
              feedbackForm.reset();
              setTimeout(() => location.reload(), 700);
            } else {
              statusEl.textContent = data.message || "Failed to submit feedback.";
              statusEl.style.color = "red";
            }
          } catch (err) {
            statusEl.textContent = "Network error.";
            statusEl.style.color = "red";
          }
        });
      }

      // Load NGO lists last
      loadNgos();
    });
  </script>

</body>

</html>
