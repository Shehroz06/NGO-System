<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="/assets/css/shell.css" />
  <style>
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:10px 0 16px}
    .toolbar .left{display:flex;gap:10px;align-items:center}
    .status{font-size:13px;color:#29443a}
    .status.err{color:#b00020}
    .muted{opacity:.8}

    .causes-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(520px, 1fr));
      gap:18px;
      margin-top:12px;
    }
    .cause-card{
      background:#fff;
      border-radius:14px;
      box-shadow:0 8px 18px rgba(0,0,0,.08);
      padding:22px 22px 18px;
      border:1px solid #eef3f0;
    }
    .cause-title{
      font-size:26px;
      font-weight:900;
      color:#1f3b2f;
      margin:0 0 6px;
    }
    .cause-meta{
      color:#6c7a73;
      font-size:13px;
      margin-bottom:14px;
    }
    .progress-wrap{
      background:#eef2ef;
      border-radius:999px;
      height:14px;
      overflow:hidden;
      margin:10px 0 14px;
    }
    .progress-bar{
      height:100%;
      background: var(--green);
      width:0%;
    }
    .cause-stats{
      display:flex;
      justify-content:space-between;
      width:100%;
      color:#2b3a34;
      font-weight:700;
      margin-top:4px;
      gap:14px;
      flex-wrap:wrap;
    }
    .btn-contribute{
      border:none;
      border-radius:10px;
      padding:10px 16px;
      font-weight:900;
      cursor:pointer;
      background:#f2a15f;
      color:#fff;
      margin-top:14px;
    }
    .small-muted{opacity:.85;font-weight:600}
  </style>
</head>
<body>
  <header>
    <div class="logo">NGO Management System</div>
    <nav>
      <a href="/admin/admin.html" class="active-menu">Admin Dashboard</a>
      <a href="/admin/admin_reports.html">Reports</a>
      <a href="/admin/admin_donations.html">Donations</a>
      <a href="#" id="logout-link">Logout</a>
    </nav>
  </header>

  <div class="dashboard-layout">
    <aside class="sidebar">
      <h2>Admin</h2>
      <ul class="sidebar-menu">
        <li><a href="/admin/admin.html" class="active-menu">Overview</a></li>
        <li><a href="/admin/admin_events.html">Approve Events</a></li>
        <li><a href="/admin/admin_causes.html">Approve Causes</a></li>
        <li><a href="/admin/admin_volunteers.html">Volunteers</a></li>
        <li><a href="/admin/admin_feedbacks.html">Feedback</a></li>
      </ul>
    </aside>

    <main class="dashboard-content">
      <h1>Admin Overview</h1>

      <div class="toolbar">
        <div class="left">
          <button id="refresh-btn" class="ghost" style="border:none;border-radius:10px;padding:8px 10px;font-weight:800;cursor:pointer;background:#f3f6f5;color:#1d2b25;">
            Refresh
          </button>
          <span class="status muted" id="status">Loading…</span>
        </div>
      </div>

      <section class="section">
        <h2>Our Causes</h2>
        <div id="causes-grid" class="causes-grid"></div>
      </section>
    </main>
  </div>

  <script src="/assets/js/auth.js"></script>
  <script>
    if(!window.auth.requireRole('admin')) { /* redirected */ }

    const API = { approved: '/api/admin/causes?status=approved' };

    const safeText = (v) => (v ?? "").toString().replace(/[<>&"]/g, c => ({
      '<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'
    }[c]));

    async function apiFetch(url, opts={}){
      const headers = Object.assign(
        { 'Content-Type': 'application/json' },
        window.auth.headers(),
        (opts.headers||{})
      );
      const res = await fetch(url, Object.assign({}, opts, { headers }));
      const ct = res.headers.get('content-type') || '';
      const data = ct.includes('application/json') ? await res.json().catch(()=>null) : await res.text().catch(()=>null);

      if(!res.ok){
        const msg = (data && data.message) ? data.message : (typeof data === 'string' ? data : `Request failed (${res.status})`);
        throw new Error(msg);
      }
      return data;
    }

    function money(n){ return `PKR ${Number(n || 0).toLocaleString()}`; }

    function renderRows(rows){
      if(!rows.length) return `<div class="cause-card">No approved causes found.</div>`;

      return rows.map(c => {
        const title = safeText(c.title);
        const manager = safeText(c.ngo_name || '—');

        const goal = Number(c.goal_amount || 0);
        const raised = Number(c.raised_amount || 0);
        const pct = goal > 0 ? Math.min(100, Math.round((raised / goal) * 100)) : 0;

        return `
          <div class="cause-card">
            <h3 class="cause-title">${title}</h3>
            <div class="cause-meta">Managed by: <b>${manager}</b></div>

            <div class="progress-wrap">
              <div class="progress-bar" style="width:${pct}%"></div>
            </div>

            <div class="cause-stats">
              <div>Goal: <span class="small-muted">${money(goal)}</span></div>
              <div>Raised: <span class="small-muted">${money(raised)} (${pct}%)</span></div>
            </div>

            <button class="btn-contribute" data-cause-id="${c.id}">Contribute Now</button>
          </div>
        `;
      }).join('');
    }

    const statusEl = document.getElementById('status');
    const gridEl = document.getElementById('causes-grid');

    function setStatus(msg, isErr=false){
      statusEl.textContent = msg;
      statusEl.classList.toggle('err', !!isErr);
      statusEl.classList.toggle('muted', !isErr);
    }

    async function load(){
      try{
        setStatus('Loading…');
        const approved = await apiFetch(API.approved);
        const rows = Array.isArray(approved) ? approved : [];
        gridEl.innerHTML = renderRows(rows);
        setStatus('Up to date.');
      }catch(err){
        gridEl.innerHTML = `<div class="cause-card">Failed to load causes.</div>`;
        setStatus(err.message || 'Failed to load', true);
      }
    }

    document.getElementById('refresh-btn').addEventListener('click', load);

    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.btn-contribute[data-cause-id]');
      if(!btn) return;
      const id = btn.getAttribute('data-cause-id');
      window.location.href = `/donate/cause.html?id=${encodeURIComponent(id)}`;
    });

    load();
  </script>
</body>
</html>
