<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - NGO Management System</title>
  <link rel="stylesheet" href="/assets/css/shell.css" />
  <style>
    body {font-family:'Segoe UI',Arial,sans-serif;margin:0;padding:0;background:#f4f7f6;color:#333}
    .container{max-width:1200px;margin:30px auto;padding:0 20px}
    h1{color:#1a5632;border-bottom:2px solid #ddd;padding-bottom:10px;margin-bottom:20px}
    .management-card{background:#fff;padding:22px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);margin-bottom:20px}

    table{width:100%;border-collapse:collapse;margin-top:10px}
    th{background:#f8f9fa;text-align:left;padding:12px;border-bottom:2px solid #eee;font-size:14px;color:#666}
    td{padding:12px;border-bottom:1px solid #eee;font-size:14px}

    .add-cause-btn{background:#1a5632;color:#fff;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:800}
    .add-cause-btn:hover{background:#134226}

    .hidden{display:none}
    #add-cause-form{background:#f9f9f9;padding:18px;border-radius:10px;margin:14px 0;border:1px solid #eee}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .form-group{margin-bottom:12px}
    .form-group label{display:block;margin-bottom:6px;font-weight:700}
    .form-group input,.form-group textarea,.form-group select{width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box}
    textarea{min-height:90px;resize:vertical}

    .submit-form-btn{background:#4CAF50;color:#fff;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:800}
    .cancel-form-btn{background:#ccc;color:#333;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;margin-left:8px;font-weight:800}

    .status{padding:4px 8px;border-radius:999px;font-size:11px;font-weight:900;text-transform:uppercase;display:inline-block}
    .status-pending{background:#fff3cd;color:#856404}
    .status-approved{background:#d4edda;color:#155724}
    .status-rejected{background:#f8d7da;color:#721c24}

    .action-btn{padding:7px 10px;border:none;border-radius:8px;cursor:pointer;color:#fff;font-weight:800}
    .delete-btn{background:#e74c3c}
  </style>
</head>

<body>
  <header>
    <div class="logo">NGO Management System</div>
    <nav>
      <a href="/admin/admin.html" class="active">Admin Dashboard</a>
      <a href="/admin/admin_reports.html">Reports</a>
      <a href="/admin/admin_donations.html">Donations</a>
      <a href="#" id="logout-link">Logout</a>
    </nav>
  </header>

  <div class="dashboard-layout">
    <aside class="sidebar">
      <h2>Admin</h2>
      <ul class="sidebar-menu">
        <li><a href="/admin/admin.html"class="active-menu" >Overview</a></li>
        <li><a href="/admin/admin_events.html">Approve Events</a></li>
        <li><a href="/admin/admin_causes.html">Approve Causes</a></li>
        <li><a href="/admin/admin_volunteers.html">Volunteers</a></li>
        <li><a href="/admin/admin_feedbacks.html">Feedback</a></li>
      </ul>
    </aside>

    <main class="dashboard-content">
      <div class="container">
        <h1>Management Console</h1>

        <div class="management-card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
            <h2 style="margin:0;color:#f4a261;">Donation Causes</h2>
            <button class="add-cause-btn" id="show-add-form-btn">+ Create New Cause</button>
          </div>

          <!-- ✅ FIX: form exists so JS won’t crash -->
          <form id="add-cause-form" class="hidden">
            <input type="hidden" id="cause-id-field" value="" />
            <h3 id="form-title" style="margin:0 0 10px;color:#1a5632;">Create New Donation Cause</h3>

            <div class="form-grid">
              <div class="form-group">
                <label for="cause-ngo-select">NGO</label>
                <select id="cause-ngo-select" required>
                  <option value="">Loading NGOs...</option>
                </select>
              </div>

              <div class="form-group">
                <label for="cause-goal">Goal Amount (PKR)</label>
                <input id="cause-goal" type="number" min="1" required placeholder="e.g., 50000" />
              </div>
            </div>

            <div class="form-group">
              <label for="cause-title">Cause Title</label>
              <input id="cause-title" required placeholder="e.g., Flood Relief Drive" />
            </div>

            <div class="form-group">
              <label for="cause-description">Description</label>
              <textarea id="cause-description" placeholder="Short description..."></textarea>
            </div>

            <div class="form-group">
              <label for="cause-status">Status</label>
              <!-- backend creates approved directly in POST /api/admin/causes, but keep UI -->
              <select id="cause-status">
                <option value="approved">approved</option>
                <option value="pending">pending</option>
                <option value="rejected">rejected</option>
              </select>
            </div>

            <button class="submit-form-btn" type="submit">Save</button>
            <button class="cancel-form-btn" type="button" id="cancel-add-form-btn">Cancel</button>
          </form>

          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Cause Title</th>
                <th>NGO</th>
                <th>Goal (PKR)</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="cause-table-body">
              <tr><td colspan="6">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- ✅ Use shared auth.js -->
  <script src="/assets/js/auth.js"></script>

  <script>
    if(!window.auth.requireRole('admin')) { /* redirected */ }

    const safeText = (v) => (v ?? "").toString().replace(/[<>&"]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[c]));
    const token = window.auth.token();

    const authHeaders = {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    };

    const addForm = document.getElementById("add-cause-form");
    const tbody = document.getElementById("cause-table-body");

    function badge(status){
      const s = (status || 'pending').toLowerCase();
      const cls = (s === 'approved') ? 'status-approved' : (s === 'rejected') ? 'status-rejected' : 'status-pending';
      return `<span class="status ${cls}">${safeText(s)}</span>`;
    }

    // Fetch NGOs for dropdown
    async function loadNgos(){
      const res = await fetch("/api/ngos");
      const ngos = await res.json().catch(()=>[]);
      const select = document.getElementById("cause-ngo-select");
      select.innerHTML = `<option value="">Select NGO</option>`;
      ngos.forEach(ngo => {
        const opt = document.createElement('option');
        opt.value = ngo.id ?? ngo.ngo_id;
        opt.textContent = ngo.name;
        select.appendChild(opt);
      });
    }

    // ✅ FIX: admin should load from /api/admin/causes not public /api/causes
    async function loadCauses(){
      const res = await fetch("/api/admin/causes", { headers: authHeaders });
      const causes = await res.json().catch(()=>[]);
      tbody.innerHTML = causes.length ? "" : "<tr><td colspan='6'>No records found.</td></tr>";

      causes.forEach(c => {
        const id = c.id ?? c.cause_id;
        const ngo = c.ngo_name || c.ngo || '';
        const goal = Number(c.goal_amount || c.goal || 0).toLocaleString();
        const status = c.status || 'pending';

        tbody.innerHTML += `
          <tr>
            <td>#${safeText(id)}</td>
            <td><strong>${safeText(c.title)}</strong></td>
            <td>${safeText(ngo)}</td>
            <td>${safeText(goal)}</td>
            <td>${badge(status)}</td>
            <td>
              <button class="action-btn delete-btn" data-del="${safeText(id)}">Delete</button>
            </td>
          </tr>
        `;
      });
    }

    document.getElementById("show-add-form-btn").addEventListener("click", () => {
      addForm.reset();
      document.getElementById("cause-id-field").value = "";
      document.getElementById("form-title").textContent = "Create New Donation Cause";
      addForm.classList.remove("hidden");
    });

    document.getElementById("cancel-add-form-btn").addEventListener("click", () => {
      addForm.classList.add("hidden");
    });

    // POST Cause (keeps your existing backend behavior)
    addForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const body = {
        ngo_id: document.getElementById('cause-ngo-select').value,
        title: document.getElementById('cause-title').value,
        description: document.getElementById('cause-description').value,
        goal_amount: document.getElementById('cause-goal').value,
        status: document.getElementById('cause-status').value
      };

      const res = await fetch("/api/admin/causes", {
        method: 'POST',
        headers: authHeaders,
        body: JSON.stringify(body)
      });

      if (res.ok) {
        alert("Cause saved successfully!");
        addForm.classList.add("hidden");
        await loadCauses();
      } else {
        const err = await res.json().catch(()=>null);
        alert(err?.message || "Error saving cause. Check permissions.");
      }
    });

    // DELETE Cause (event delegation)
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('button[data-del]');
      if(!btn) return;
      const id = btn.getAttribute('data-del');
      if (!confirm("Are you sure? This action cannot be undone.")) return;

      const res = await fetch(`/api/admin/causes/${id}`, {
        method: 'DELETE',
        headers: authHeaders
      });

      if (res.ok) {
        await loadCauses();
      } else {
        const err = await res.json().catch(()=>null);
        alert(err?.message || "Delete failed.");
      }
    });

    (async function init(){
      await loadNgos();
      await loadCauses();
    })();
  </script>
</body>
</html>
